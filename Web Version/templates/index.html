<!DOCTYPE html>
<html lang="hi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>рд╣рд┐рдВрджреА рд╕реНрдкреАрдЪ рдЯреНрд░рд╛рдВрд╕рдХреНрд░рд┐рдкреНрд╢рди</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Noto Sans Devanagari", sans-serif;
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-2xl">
      <h1 class="text-2xl font-bold text-center text-gray-800 mb-4">
        ЁЯОд рд╣рд┐рдВрджреА рд╕реНрдкреАрдЪ рдЯреНрд░рд╛рдВрд╕рдХреНрд░рд┐рдкреНрд╢рди
      </h1>

      <label class="block text-sm font-medium text-gray-700 mb-2"
        >ЁЯУМ рд╢реАрд░реНрд╖рдХ:</label
      >
      <input
        id="heading-input"
        type="text"
        placeholder="рд╢реАрд░реНрд╖рдХ рджрд░реНрдЬ рдХрд░реЗрдВ..."
        class="w-full p-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 mb-4"
      />

      <div class="flex space-x-4 mb-4">
        <button
          id="start-button"
          class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 active:bg-blue-800"
        >
          ЁЯОЩя╕П рд░рд┐рдХреЙрд░реНрдбрд┐рдВрдЧ рд╢реБрд░реВ рдХрд░реЗрдВ
        </button>
        <button
          id="stop-button"
          class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 active:bg-red-800"
          disabled
        >
          ЁЯЫС рд░рд┐рдХреЙрд░реНрдбрд┐рдВрдЧ рд░реЛрдХреЗрдВ
        </button>
      </div>

      <p id="status-label" class="text-sm text-gray-600 mb-4"></p>

      <label class="block text-sm font-medium text-gray-700 mb-2"
        >ЁЯУЭ рдкреНрд░рддрд┐рд▓реЗрдЦ:</label
      >
      <textarea
        id="transcript-area"
        class="w-full p-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 mb-4"
        rows="6"
      ></textarea>

      <label class="block text-sm font-medium text-gray-700 mb-2"
        >ЁЯПв рдЕрдзрд┐рдХрд╛рд░рд┐рдпреЛрдВ рдХреЛ рдЕрд╕рд╛рдЗрди рдХрд░реЗрдВ:</label
      >
      <select
        id="officers-dropdown"
        multiple
        class="w-full p-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 mb-4"
      >
        {% for officer in officers %}
        <option value="{{ officer }}">{{ officer }}</option>
        {% endfor %}
      </select>
      <label class="flex items-center mb-4">
        <input type="checkbox" id="assign-all" class="mr-2" />
        <span>рд╕рднреА рдЕрдзрд┐рдХрд╛рд░рд┐рдпреЛрдВ рдХреЛ рдЕрд╕рд╛рдЗрди рдХрд░реЗрдВ</span>
      </label>

      <div class="flex space-x-4">
        <button
          id="save-button"
          class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 active:bg-green-800 flex-1"
        >
          ЁЯТ╛ рдЯрд╛рд╕реНрдХ рд╕рд╣реЗрдЬреЗрдВ
        </button>
        <a
          href="/transcripts"
          class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 active:bg-purple-800 text-center"
        >
          ЁЯУЬ рд╕рднреА рдЯрд╛рд╕реНрдХ рджреЗрдЦреЗрдВ
        </a>
      </div>
    </div>

    <script>
      const recognition = new (window.SpeechRecognition ||
        window.webkitSpeechRecognition)();
      recognition.lang = "hi-IN";
      recognition.interimResults = true;
      recognition.continuous = true;

      const startButton = document.getElementById("start-button");
      const stopButton = document.getElementById("stop-button");
      const statusLabel = document.getElementById("status-label");
      const transcriptArea = document.getElementById("transcript-area");
      const saveButton = document.getElementById("save-button");
      const headingInput = document.getElementById("heading-input");
      const officersDropdown = document.getElementById("officers-dropdown");
      const assignAllCheckbox = document.getElementById("assign-all");

      let isRecording = false;

      recognition.onstart = () => {
        isRecording = true;
        statusLabel.textContent = "ЁЯОЩя╕П рд░рд┐рдХреЙрд░реНрдбрд┐рдВрдЧ рд╢реБрд░реВ...";
        startButton.disabled = true;
        stopButton.disabled = false;
      };

      recognition.onresult = (event) => {
        let interimTranscript = "";
        let finalTranscript = "";

        for (let i = event.resultIndex; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            finalTranscript += transcript + " ";
          } else {
            interimTranscript += transcript;
          }
        }

        transcriptArea.value = finalTranscript + interimTranscript;
      };

      recognition.onend = () => {
        if (isRecording) {
          recognition.start();
        } else {
          statusLabel.textContent = "ЁЯЫС рд░рд┐рдХреЙрд░реНрдбрд┐рдВрдЧ рд░реБрдХреА";
          startButton.disabled = false;
          stopButton.disabled = true;
        }
      };

      recognition.onerror = (event) => {
        statusLabel.textContent = `тЭМ рддреНрд░реБрдЯрд┐: ${event.error}`;
        startButton.disabled = false;
        stopButton.disabled = true;
        isRecording = false;
      };

      startButton.addEventListener("click", () => {
        recognition.start();
      });

      stopButton.addEventListener("click", () => {
        isRecording = false;
        recognition.stop();
      });

      assignAllCheckbox.addEventListener("change", () => {
        officersDropdown.disabled = assignAllCheckbox.checked;
        if (assignAllCheckbox.checked) {
          Array.from(officersDropdown.options).forEach(
            (option) => (option.selected = false)
          );
        }
      });

      saveButton.addEventListener("click", async () => {
        const heading = headingInput.value;
        const transcript = transcriptArea.value;
        const assignToAll = assignAllCheckbox.checked;
        const officers = assignToAll
          ? []
          : Array.from(officersDropdown.selectedOptions).map(
              (option) => option.value
            );

        try {
          const response = await fetch("/save_transcript", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              heading,
              transcript,
              officers,
              assign_to_all: assignToAll,
            }),
          });

          const result = await response.json();
          if (response.ok) {
            statusLabel.textContent = "тЬЕ " + result.message;
          } else {
            statusLabel.textContent = "тЭМ " + result.error;
          }
        } catch (error) {
          statusLabel.textContent = `тЭМ рдЯрд╛рд╕реНрдХ рд╕рд╣реЗрдЬрдиреЗ рдореЗрдВ рддреНрд░реБрдЯрд┐: ${error.message}`;
        }
      });
    </script>
  </body>
</html>
