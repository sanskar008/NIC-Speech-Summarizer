<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡§∏‡§≠‡•Ä ‡§ü‡§æ‡§∏‡•ç‡§ï</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans Devanagari', sans-serif;
        }
        textarea {
            resize: vertical;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-6">
    <div class="max-w-5xl mx-auto bg-white p-6 rounded-lg shadow-lg">
        <h1 class="text-2xl font-bold text-center text-gray-800 mb-4">üìú ‡§∏‡§≠‡•Ä ‡§ü‡§æ‡§∏‡•ç‡§ï</h1>
        <a href="/" class="inline-block bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 mb-4">‚Üê ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§™‡•É‡§∑‡•ç‡§† ‡§™‡§∞ ‡§µ‡§æ‡§™‡§∏</a>
        <div id="transcripts-list" class="overflow-x-auto">
            <table class="w-full border-collapse">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="border p-2 text-left">‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï</th>
                        <th class="border p-2 text-left">‡§™‡•ç‡§∞‡§§‡§ø‡§≤‡•á‡§ñ</th>
                        <th class="border p-2 text-left">‡§Ö‡§∏‡§æ‡§á‡§® ‡§ï‡§ø‡§è ‡§ó‡§è ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞‡•Ä</th>
                        <th class="border p-2 text-left">‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï</th>
                        <th class="border p-2 text-left">‡§ï‡§æ‡§∞‡•ç‡§∞‡§µ‡§æ‡§à</th>
                    </tr>
                </thead>
                <tbody id="transcripts-table-body"></tbody>
            </table>
        </div>
    </div>

    <script>
        // Debug officers parsing
        let availableOfficers;
        try {
            availableOfficers = JSON.parse('{{ officers | tojson | safe }}');
            console.log('Available Officers:', availableOfficers);
        } catch (e) {
            console.error('Error parsing officers:', e);
            availableOfficers = []; // Fallback to empty array
        }

        async function loadTranscripts() {
            const transcriptsTableBody = document.getElementById('transcripts-table-body');
            try {
                console.log('Fetching tasks from /get_transcripts...');
                const response = await fetch('/get_transcripts');
                const result = await response.json();
                console.log('Fetch result:', result);

                if (response.ok) {
                    if (result.length === 0) {
                        transcriptsTableBody.innerHTML = '<tr><td colspan="5" class="border p-2 text-center text-gray-600">‡§ï‡•ã‡§à ‡§ü‡§æ‡§∏‡•ç‡§ï ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç</td></tr>';
                    } else {
                        transcriptsTableBody.innerHTML = '';
                        result.forEach(task => {
                            const escapeHTML = str => str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
                            const officerOptions = availableOfficers.map(officer => 
                                `<option value="${escapeHTML(officer)}" ${task.officers.includes(officer) ? 'selected' : ''}>${escapeHTML(officer)}</option>`
                            ).join('');
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td class="border p-2">
                                    <input type="text" value="${escapeHTML(task.heading)}" class="w-full p-1 border rounded" data-id="${task.id}" data-field="heading">
                                </td>
                                <td class="border p-2">
                                    <textarea class="w-full p-1 border rounded" rows="3" data-id="${task.id}" data-field="transcript">${escapeHTML(task.transcript)}</textarea>
                                </td>
                                <td class="border p-2">
                                    <select multiple class="w-full p-1 border rounded" data-id="${task.id}" data-field="officers">
                                        ${officerOptions}
                                    </select>
                                    <label class="flex items-center mt-2">
                                        <input type="checkbox" class="assign-all-checkbox mr-2" data-id="${task.id}" ${task.officers.length === availableOfficers.length ? 'checked' : ''}>
                                        <span>‡§∏‡§≠‡•Ä ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•ã ‡§Ö‡§∏‡§æ‡§á‡§® ‡§ï‡§∞‡•á‡§Ç</span>
                                    </label>
                                </td>
                                <td class="border p-2">${new Date(task.created_at).toLocaleString('hi-IN')}</td>
                                <td class="border p-2">
                                    <button class="save-button bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700" data-id="${task.id}">‡§∏‡§π‡•á‡§ú‡•á‡§Ç</button>
                                </td>
                            `;
                            transcriptsTableBody.appendChild(tr);
                        });

                        // Add event listeners for save buttons
                        document.querySelectorAll('.save-button').forEach(button => {
                            button.addEventListener('click', async (e) => {
                                const id = e.target.getAttribute('data-id');
                                const row = e.target.closest('tr');
                                const heading = row.querySelector('input[data-field="heading"]').value.trim();
                                const transcript = row.querySelector('textarea[data-field="transcript"]').value.trim();
                                const officersSelect = row.querySelector('select[data-field="officers"]');
                                const assignAll = row.querySelector('.assign-all-checkbox').checked;
                                const officers = assignAll ? [] : Array.from(officersSelect.selectedOptions).map(option => option.value);

                                try {
                                    const response = await fetch(`/update_transcript/${id}`, {
                                        method: 'PUT',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ heading, transcript, officers, assign_to_all: assignAll })
                                    });
                                    const result = await response.json();
                                    alert(response.ok ? result.message : result.error);
                                    if (response.ok) loadTranscripts();
                                } catch (error) {
                                    alert(`‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${error.message}`);
                                }
                            });
                        });

                        // Handle assign all checkbox
                        document.querySelectorAll('.assign-all-checkbox').forEach(checkbox => {
                            checkbox.addEventListener('change', (e) => {
                                const row = e.target.closest('tr');
                                const officersSelect = row.querySelector('select[data-field="officers"]');
                                officersSelect.disabled = e.target.checked;
                                if (e.target.checked) {
                                    Array.from(officersSelect.options).forEach(option => option.selected = false);
                                }
                            });
                        });
                    }
                } else {
                    transcriptsTableBody.innerHTML = `<tr><td colspan="5" class="border p-2 text-center text-red-600">‚ùå ${result.error}</td></tr>`;
                }
            } catch (error) {
                console.error('Fetch error:', error);
                transcriptsTableBody.innerHTML = `<tr><td colspan="5" class="border p-2 text-center text-red-600">‚ùå ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${error.message}</td></tr>`;
            }
        }

        window.onload = loadTranscripts;
    </script>
</body>
</html>