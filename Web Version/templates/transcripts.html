<!DOCTYPE html>
<html lang="hi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‡§∏‡§≠‡•Ä ‡§ü‡§æ‡§∏‡•ç‡§ï</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Noto Sans Devanagari", sans-serif;
      }
      textarea {
        resize: vertical;
      }
      select[multiple] {
        height: 100px;
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen p-6">
    <div class="max-w-6xl mx-auto bg-white p-6 rounded-lg shadow-lg">
      <h1 class="text-2xl font-bold text-center text-gray-800 mb-4">
        üìú ‡§∏‡§≠‡•Ä ‡§ü‡§æ‡§∏‡•ç‡§ï
      </h1>
      <a
        href="/"
        class="inline-block bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 mb-4"
        >‚Üê ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§™‡•É‡§∑‡•ç‡§† ‡§™‡§∞ ‡§µ‡§æ‡§™‡§∏</a
      >
      <div id="transcripts-list" class="overflow-x-auto">
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-gray-200">
              <th class="border p-2 text-left">‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï</th>
              <th class="border p-2 text-left">‡§µ‡§ø‡§µ‡§∞‡§£</th>
              <th class="border p-2 text-left">‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞‡•Ä ‡§Ö‡§∏‡§æ‡§á‡§® ‡§ï‡§∞‡•á‡§Ç</th>
              <th class="border p-2 text-left">‡§Ö‡§∏‡§æ‡§á‡§® ‡§ï‡§ø‡§è ‡§ó‡§è ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞‡•Ä</th>
              <th class="border p-2 text-left">‡§Ö‡§™‡§°‡•á‡§ü ‡§ü‡§ø‡§™‡•ç‡§™‡§£‡•Ä</th>
              <th class="border p-2 text-left">‡§∏‡§Æ‡§Ø ‡§∏‡•Ä‡§Æ‡§æ</th>
              <th class="border p-2 text-left">‡§∏‡•ç‡§•‡§ø‡§§‡§ø</th>
              <th class="border p-2 text-left">‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï</th>
              <th class="border p-2 text-left">‡§ï‡§æ‡§∞‡•ç‡§∞‡§µ‡§æ‡§à</th>
            </tr>
          </thead>
          <tbody id="transcripts-table-body"></tbody>
        </table>
      </div>
    </div>

    <script id="officers-data" type="application/json">
      {{ officers | tojson | safe }}
    </script>
    <script>
      let availableOfficers = [];
      try {
        const officersData = document.getElementById("officers-data");
        availableOfficers = JSON.parse(officersData.textContent);
        console.log("Available Officers:", availableOfficers);
        if (!availableOfficers.length) {
          console.warn("No officers loaded; select will be empty");
        }
      } catch (e) {
        console.error("Error parsing officers:", e);
        alert("‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞‡•Ä ‡§∏‡•Ç‡§ö‡•Ä ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: " + e.message);
      }

      async function loadTranscripts() {
        const transcriptsTableBody = document.getElementById(
          "transcripts-table-body"
        );
        try {
          console.log("Fetching tasks from /get_transcripts...");
          const response = await fetch("/get_transcripts", {
            credentials: "include",
          });
          console.log("Response status:", response.status);
          const result = await response.json();
          console.log("Fetch result:", result);

          if (response.ok) {
            if (!result || result.length === 0) {
              transcriptsTableBody.innerHTML =
                '<tr><td colspan="9" class="border p-2 text-center text-gray-600">‡§ï‡•ã‡§à ‡§ü‡§æ‡§∏‡•ç‡§ï ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç</td></tr>';
            } else {
              transcriptsTableBody.innerHTML = "";
              result.forEach((task) => {
                const escapeHTML = (str) =>
                  String(str || "")
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#39;");

                // Main row
                const officerOptions = availableOfficers
                  .map(
                    (officer) =>
                      `<option value="${escapeHTML(officer)}" ${
                        task.assignments.some((a) => a.officer === officer)
                          ? "selected"
                          : ""
                      }>${escapeHTML(officer)}</option>`
                  )
                  .join("");

                const tr = document.createElement("tr");
                tr.innerHTML = `
                  <td class="border p-2" rowspan="${Math.max(
                    1,
                    task.assignments.length
                  )}">
                  <input type="text" value="${escapeHTML(
                    task.heading
                  )}" class="w-full p-1 border rounded" data-id="${
                  task.id
                }" data-field="heading">
                  </td>
                  <td class="border p-2" rowspan="${Math.max(
                    1,
                    task.assignments.length
                  )}">
                  <textarea class="w-full p-1 border rounded" rows="3" data-id="${
                    task.id
                  }" data-field="transcript">${escapeHTML(
                  task.transcript
                )}</textarea>
                  </td>
                  <td class="border p-2" rowspan="${Math.max(
                    1,
                    task.assignments.length
                  )}">
                  <select multiple class="w-full p-1 border rounded" data-id="${
                    task.id
                  }" data-field="officers" title="Ctrl+‡§ï‡•ç‡§≤‡§ø‡§ï ‡§∏‡•á ‡§è‡§ï‡§æ‡§ß‡§ø‡§ï ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞‡•Ä ‡§ö‡•Å‡§®‡•á‡§Ç">
                    ${officerOptions}
                  </select>
                  <label class="flex items-center mt-2">
                    <input type="checkbox" class="assign-all-checkbox mr-2" data-id="${
                      task.id
                    }" ${
                  task.assignments.length === availableOfficers.length
                    ? "checked"
                    : ""
                }>
                    <span>‡§∏‡§≠‡•Ä ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•ã ‡§Ö‡§∏‡§æ‡§á‡§® ‡§ï‡§∞‡•á‡§Ç</span>
                  </label>
                  </td>
                  <td class="border p-2 text-sm text-gray-600">
                  ${
                    task.assignments.length > 0
                      ? escapeHTML(task.assignments[0].officer)
                      : "‡§ï‡•ã‡§à ‡§®‡§π‡•Ä‡§Ç"
                  }
                  </td>
                  <td class="border p-2 text-sm text-gray-600">
                  ${
                    task.assignments.length > 0
                      ? task.assignments[0].update_comment
                        ? escapeHTML(task.assignments[0].update_comment)
                        : "‡§ï‡•ã‡§à ‡§Ö‡§™‡§°‡•á‡§ü ‡§®‡§π‡•Ä‡§Ç"
                      : "‡§ï‡•ã‡§à ‡§Ö‡§™‡§°‡•á‡§ü ‡§®‡§π‡•Ä‡§Ç"
                  }
                  </td>
                  <td class="border p-2" rowspan="${Math.max(
                    1,
                    task.assignments.length
                  )}">
                  <input type="datetime-local" value="${
                    task.deadline ? task.deadline.slice(0, 16) : ""
                  }" class="w-full p-1 border rounded" data-id="${
                  task.id
                }" data-field="deadline">
                  </td>
                  <td class="border p-2" rowspan="${Math.max(
                    1,
                    task.assignments.length
                  )}">
                  ${
                    task.status === "pending"
                      ? "‡§™‡•ç‡§∞‡§≤‡§Ç‡§¨‡§ø‡§§"
                      : task.status === "in_progress"
                      ? "‡§™‡•ç‡§∞‡§ó‡§§‡§ø ‡§Æ‡•á‡§Ç"
                      : "‡§™‡•Ç‡§∞‡•ç‡§£"
                  }
                  </td>
                  <td class="border p-2" rowspan="${Math.max(
                    1,
                    task.assignments.length
                  )}">
                  ${new Date(task.created_at).toLocaleString("hi-IN")}
                  </td>
                  <td class="border p-2 flex space-x-2" rowspan="${Math.max(
                    1,
                    task.assignments.length
                  )}">
                  <button class="save-button bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700" data-id="${
                    task.id
                  }">‡§∏‡§π‡•á‡§ú‡•á‡§Ç</button>
                  <button class="delete-button bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700" data-id="${
                    task.id
                  }">‡§π‡§ü‡§æ‡§è‡§Ç</button>
                  </td>
                `;
                transcriptsTableBody.appendChild(tr);

                // Sub-rows for additional assignments
                if (task.assignments.length > 1) {
                  for (let i = 1; i < task.assignments.length; i++) {
                    const subTr = document.createElement("tr");
                    subTr.innerHTML = `
                    <td class="border p-2 text-sm text-gray-600">
                    ${escapeHTML(task.assignments[i].officer)}
                    </td>
                    <td class="border p-2 text-sm text-gray-600">
                    ${
                      task.assignments[i].update_comment
                        ? escapeHTML(task.assignments[i].update_comment)
                        : "‡§ï‡•ã‡§à ‡§Ö‡§™‡§°‡•á‡§ü ‡§®‡§π‡•Ä‡§Ç"
                    }
                    </td>
                  `;
                    transcriptsTableBody.appendChild(subTr);
                  }
                }
              });

              document.querySelectorAll(".save-button").forEach((button) => {
                button.addEventListener("click", async (e) => {
                  const id = e.target.getAttribute("data-id");
                  const row = e.target.closest("tr");
                  const heading = row
                    .querySelector('input[data-field="heading"]')
                    .value.trim();
                  const transcript = row
                    .querySelector('textarea[data-field="transcript"]')
                    .value.trim();
                  const officersSelect = row.querySelector(
                    'select[data-field="officers"]'
                  );
                  const assignAll = row.querySelector(
                    ".assign-all-checkbox"
                  ).checked;
                  const officers = assignAll
                    ? []
                    : Array.from(officersSelect.selectedOptions).map(
                        (option) => option.value
                      );
                  const deadline = row.querySelector(
                    'input[data-field="deadline"]'
                  ).value;

                  if (
                    !heading ||
                    !transcript ||
                    (!officers.length && !assignAll)
                  ) {
                    alert(
                      "‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï, ‡§™‡•ç‡§∞‡§§‡§ø‡§≤‡•á‡§ñ, ‡§î‡§∞ ‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ ‡§è‡§ï ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞‡•Ä ‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø ‡§π‡•à‡§Ç"
                    );
                    return;
                  }

                  try {
                    const response = await fetch(`/update_transcript/${id}`, {
                      method: "PUT",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({
                        heading,
                        transcript,
                        officers,
                        assign_to_all: assignAll,
                        deadline,
                      }),
                    });
                    const result = await response.json();
                    alert(response.ok ? result.message : result.error);
                    if (response.ok) loadTranscripts();
                  } catch (error) {
                    alert(`‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${error.message}`);
                  }
                });
              });

              document.querySelectorAll(".delete-button").forEach((button) => {
                button.addEventListener("click", async (e) => {
                  const id = e.target.getAttribute("data-id");
                  if (!confirm("‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§á‡§∏ ‡§ü‡§æ‡§∏‡•ç‡§ï ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?")) return;
                  try {
                    const response = await fetch(`/delete_transcript/${id}`, {
                      method: "DELETE",
                      headers: { "Content-Type": "application/json" },
                    });
                    const result = await response.json();
                    alert(response.ok ? result.message : result.error);
                    if (response.ok) loadTranscripts();
                  } catch (error) {
                    alert(`‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${error.message}`);
                  }
                });
              });

              document
                .querySelectorAll(".assign-all-checkbox")
                .forEach((checkbox) => {
                  checkbox.addEventListener("change", (e) => {
                    const row = e.target.closest("tr");
                    const officersSelect = row.querySelector(
                      'select[data-field="officers"]'
                    );
                    officersSelect.disabled = e.target.checked;
                    if (e.target.checked) {
                      Array.from(officersSelect.options).forEach(
                        (option) => (option.selected = false)
                      );
                    }
                  });
                });
            }
          } else {
            transcriptsTableBody.innerHTML = `<tr><td colspan="9" class="border p-2 text-center text-red-600">‚ùå ${result.error}</td></tr>`;
          }
        } catch (error) {
          console.error("Fetch error:", error);
          transcriptsTableBody.innerHTML = `<tr><td colspan="9" class="border p-2 text-center text-red-600">‚ùå ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${error.message}</td></tr>`;
        }
      }

      window.onload = loadTranscripts;
    </script>
  </body>
</html>
